#!/bin/bash -l
GLOBALSIZE=1
GLOBALRANK=${SLURM_PROCID:-$(($GLOBALSIZE * 2))}
export OMP_NUM_THREADS=1
LOCALSIZE=${SLURM_NTASKS_PER_NODE:-1}

LOCALRANK=${MPI_LOCALRANKID:-$SLURM_LOCALID}

which `basename /home/hpc/unrz/unrz139/.modules/likwid-master-mpirun/bin/likwid-perfctr` 1>/dev/null 2>&1
if [ $? -eq 1 ]; then
	module load likwid 1>/dev/null 2>&1
fi

if [ "$LOCALRANK" -eq 0 ]; then
	/home/hpc/unrz/unrz139/.modules/likwid-master-mpirun/bin/likwid-perfctr -m -f  -C L:N:0-0 -g INSTR_RETIRED_ANY:FIXC0,CPU_CLK_UNHALTED_CORE:FIXC1,CPU_CLK_UNHALTED_REF:FIXC2,TOPDOWN_SLOTS:FIXC3,FP_ARITH_INST_RETIRED_128B_PACKED_DOUBLE:PMC0,FP_ARITH_INST_RETIRED_SCALAR_DOUBLE:PMC1,FP_ARITH_INST_RETIRED_256B_PACKED_DOUBLE:PMC2,FP_ARITH_INST_RETIRED_512B_PACKED_DOUBLE:PMC3,PWR_PKG_ENERGY:PWR0,PWR_DRAM_ENERGY:PWR3,CAS_COUNT_RD:MBOX0C0,CAS_COUNT_WR:MBOX0C1,CAS_COUNT_RD:MBOX1C0,CAS_COUNT_WR:MBOX1C1,CAS_COUNT_RD:MBOX2C0,CAS_COUNT_WR:MBOX2C1,CAS_COUNT_RD:MBOX3C0,CAS_COUNT_WR:MBOX3C1,CAS_COUNT_RD:MBOX4C0,CAS_COUNT_WR:MBOX4C1,CAS_COUNT_RD:MBOX5C0,CAS_COUNT_WR:MBOX5C1,CAS_COUNT_RD:MBOX6C0,CAS_COUNT_WR:MBOX6C1,CAS_COUNT_RD:MBOX7C0,CAS_COUNT_WR:MBOX7C1 -o /home/hpc/ihpc/ihpc040h/LULESH_AD/LULESH/run/Sec4_MPI/.output_2961645_%r_%h.csv ../../build_MPI/lulesh2.0 -p -b 0 -s 150 -i 300 -c 0
else
	echo "Unknown local rank $LOCALRANK"
fi
